---
title: "HW_4_Chitadze"
output: html_document
date: "2024-04-03"
---

## Тема:

Использование основных статистических тестов и поправок на множественные сравнения

## Цель:

Разберем использование основных параметрических и непараметрических статистических тестов, научимся вводить поправки на множественные сравнения, поймем, чем они отличаются.

```{r}
# импортируем библиотеки
library(ggplot2)
library(tidyverse)
 library(car)
```

## Задача 1

Рассмотрите следующую статистическую гипотезу. Проводят некоторое исследование пациентов с артериальной гипертензией. Предположим, что внедрение нового препарата в среднем лучше снижает их давление по сравнению со стандартной терапией. Задайте seed для воспроизводимости результатом (функция set.seed()). Задайте размер выборки sample_size \<- 30. Задайте значение среднего артериального давления до приема нового препарата и после. Сформулируйте нулевую и альтернативную гипотезы. Определите уровень значимости. Выберите статистический тест для проверки гипотезы и аргументируйте свой выбор. Определите наблюдаемое значение статистики, а также критическое значение статистики. Оцените и прокомментируйте статистическую значимость.

```{r}
# Задаем seed
set.seed(12)

# Размер выборки
sample_size <- 30

# Среднее систолическое артериальное давление до и после приема препарата
mean_tension_before <- 145  
mean_tension_after <- 125  

# Генерируем данные из нормального распределения с заданным стандартным отклонением для до
sd_tension <- 14
tension_before <- rnorm(sample_size, mean_tension_before, sd_tension)

# Стандартное отклонение во второй выборке(после)
sd_tension_after <- 8
tension_after <- rnorm(sample_size, mean_tension_after, sd_tension_after)

# Объединяем в один датасет
tension <- data.frame(Tension_Before = tension_before,
                            Tension_After = tension_after)
# Выводим результат
head(tension)
```

H0 (нулевая гипотеза) - артериальное давление до и после приема препарата статистически значимо не отличаются\`

H1 (альтернативная гипотеза) - есть статистически значимая разница между артериальным давлением до и после приема препарата\`

$$
\alpha = 0.05
$$

```{r}
# Визиализируем оценку распределения артериального давления до приема препарата для понимания распределение данных

ggplot(tension, aes(x = Tension_Before)) +
  geom_histogram(binwidth = 5,fill = "red", color = "black") +
  labs(title = "Гистограмма распределения артериального давления до приема препарата", x = "Значения", y = "Частота") +
  theme_minimal()
```

Визуально данные имеют нормальное распределение,хотя оно не идеально нормальное.

```{r}
# Визиализируем оценку распределения артериального давления после приема препарата для понимания распределение данных

ggplot(tension, aes(x = Tension_After)) +
  geom_histogram(binwidth = 3, fill = "green", color = "black") +
  labs(title = "Гистограмма распределения артериального давления после приема препарата", x = "Значения", y = "Частота") +
  theme_minimal()
```

Распределение не очень похоже на нормальное

```{r}
# Проводим тест Шапиро-Уилка на нормальность распределения
# H0 - распределение нормальное
# H1 - распределение отлично от нормального
# alpha = 0.05
shapiro.test(tension $Tension_Before)
shapiro.test(tension $Tension_After)
```

В обоих случаях `p-value > alpha`, не можем отвергнуть Н0,значит принимает,что распределение в обеих выборках нормальное.

Так как данные распределены нормально, то для поиска статистически значимых различий в данном случае можно применить парный t-test.

```{r}
# Определяем средние значения для каждой выборки
mean(tension$Tension_Before)
mean(tension$TensionAfter)
# проводим парный t-test
t.test(tension$Tension_Before,tension$Tension_After, paired = TRUE)
```

```{r}
# Расчет критического значения для нормального распределения, где степени свободы = 29 и alpha = 0.05
alpha = 0.05
qt(1 - alpha/2, df = 29)
```

По результатам наблюдаемое значение статистики (7.75) значительно превышает критическое значение 2.045 для 29 степеней свободы на уровне значимости 0.05.

`p-value < alpha`, следовательно мы отвергаем Н0 и принимаем Н1, что есть статистически значимая разница между артериальным давлением до и после приема препарата. Следовательно, наш препарат эффективен в снижении систолического артериального давления.

95% доверительный интервал не включает ноль, что подтверждает значимость различия средних.

## Задание 2

Рассмотрите следующую статистическую гипотезу. Существует некоторая связь между курением и развитием рака легких. Пусть у курящих людей вероятность заболеть раком легких составляет 0.8, а у некурящих – 0.2 Рассмотрите два случая: для выборки sample_size1 \<- 100 и sample_size2 \<- 30. Сгенерируйте данные по курению с помощью функции rep(), пусть отношение числа курящих к некурящим в каждой выборке составляет 1:1. Сформулируйте нулевую и альтернативную гипотезы. Определите уровень значимости. Выберите статистический тест для проверки гипотезы и аргументируйте свой выбор. Определите наблюдаемое значение статистики, а также критическое значение статистики. Оцените и прокомментируйте статистическую значимость.

```{r}
# Размер первой выбороки
sample_size1 <- 100

# Создаем вектор курящих (1) и некурящих (0)
smoking <- rep(c(1, 0), each = (sample_size1 / 2))

# Генерируем данные для рака легких с заданной вероятностью
set.seed(13) 
cancer_and_smoking <- rbinom((sample_size1 / 2), 1, 0.8)
cancer_and_nonsmoking <- rbinom((sample_size1 / 2), 1, 0.2)

# Объединяем данные рака легких для курящих и некурящих
lung_cancer <- c(cancer_and_smoking, cancer_and_nonsmoking)

# Создаем фрейм данных
sample100 <- data.frame(Smoking = smoking,
                        LungCancer = lung_cancer)

# Смотрим результат
head(sample100)
```

```{r}
# Размер второй выбороки
sample_size2 <- 30

# Создаем вектор курящих (1) и некурящих (0)
smoking <- rep(c(1, 0), each = (sample_size2 / 2))

# Генерируем данные для рака легких с заданной вероятностью
set.seed(1) 
cancer_and_smoking <- rbinom((sample_size2 / 2), 1, 0.8)
cancer_and_nonsmoking <- rbinom((sample_size2 / 2), 1, 0.2)

# Объединяем данные рака легких для курящих и некурящих
lung_cancer <- c(cancer_and_smoking, cancer_and_nonsmoking)

# Создаем фрейм данных
sample30 <- data.frame(Smoking = smoking,
                        LungCancer = lung_cancer)

# Смотрим результат
head(sample30)
```

H0 (нулевая гипотеза) - вероятность развития рака легких в обеих группах (курящие и некурящие) одинакова (статистически незначимая разница)

H1 (альтернативная гипотеза) - в группе курящих риск развития рака легких статистически значимо выше, чем в группе некурящих.

$$
\alpha = 0.05
$$

```{r}
# Визуализируем данные для первой выборки 
barplot(table(sample100$Smoking, sample100$LungCancer), beside = TRUE,
        col = c("red", "green"), legend = c("Нет рака легких", "Рак легких"),
        names.arg = c("Некурящие", "Курящие"), main = "Рак легких среди курящих и некурящих людей (выборка 100)",
        ylab = "Количество наблюдений")
```

```{r}
# Визуализируем данные для второй выборки
barplot(table(sample30$Smoking, sample30$LungCancer), beside = TRUE,
        col = c("red", "green"), legend = c("Нет рака легких", "Рак легких"),
        names.arg = c("Некурящие", "Курящие"), main = "Рак легких среди курящих и некурящих людей (выборка 30)",
        ylab = "Количество наблюдений")
```

Обе переменные категориальный. В обоих выборках событие(рак легких) распределено неравномерно. Наблюдения независимы между собой.

Выбираем тест Фишера. Так кактеста Фишера обосновывается необходимостью проверки равенства дисперсий между двумя выборками или группами данных.

```{r}
# Статистический тест для проверки гипотез на выбрке со 100 наблюдениями
# Таблица сопряженности для курящих и некурящих
contingency_table100 <- table(sample100$Smoking, sample100$LungCancer)

# Применяем точный тест Фишера
# в соответствии с формулировкой альтернативной гипотезы выбираем alternative = "greater" - одностороняя гипотеза
fisher_test_result100 <- fisher.test(contingency_table100, alternative = "greater")

# Выводим результаты теста
fisher_test_result100
```

```{r}
# Аналогично  тест для выборки с 30 наблюдениями
contingency_table30 <- table(sample30$Smoking, sample30$LungCancer)

fisher_test_result30 <- fisher.test(contingency_table30, alternative = "greater")

fisher_test_result30
```

Формула расчета p-value для точного теста Фишера

$$
p= \frac{(a+b)!×(c+d)!×(a+c)!×(b+d)}{!a!×b!×c!×d!×n!}
$$

Исходя из результатов теста Фишера для обеих выборок:

Для первой выборки:

p-значение (p-value) очень мало (1.066e-09), что означает, что существует статистически значимая связь между рассматриваемыми переменными. Альтернативная гипотеза указывает на то, что истинное отношение шансов больше 1. Доверительный интервал для отношения шансов (95%) начинается от 6.334827 и не имеет верхней границы. Оценка отношения шансов составляет 15.552. Для второй выборки:

p-значение (p-value) также мало (0.001407), что указывает на статистически значимую связь между рассматриваемыми переменными. Альтернативная гипотеза также указывает на то, что истинное отношение шансов больше 1. Доверительный интервал для отношения шансов (95%) начинается от 2.660628 и не имеет верхней границы. Оценка отношения шансов составляет 14.11256. Таким образом, на основе теста Фишера для обеих выборок можно сделать вывод о том, что в группе курящих риск развития рака легких статистически значимо выше, чем в группе некурящи,следовательно мы отвергаем Н0 и принимаем Н1.

## Задание 3

Рассмотрите следующую статистическую гипотезу. Применение нового метода лечения синдрома раздраженного кишечника значимо меняет уровень болевых симптомов по сравнению с группой, прошедшей лечение диетотерапией. (исследователь избегает любых допущений, кроме того, что выборки независимы и имеют одинаковое распределение) Сформулируйте нулевую и альтернативную гипотезы. Определите уровень значимости. Выберите статистический тест для проверки гипотезы и аргументируйте свой выбор. Определите наблюдаемое значение статистики, а также критическое значение статистики. Оцените и прокомментируйте статистическую значимость.

```{r}
set.seed(42)
sample_size <- 50

# Средние и стандартные отклонения для каждой группы
mean_treatment <- 4
sd_treatment <- 2
mean_diet_therapy <- 6
sd_diet_therapy <- 2

# Генерируем выборки
treatment_group <- round(rnorm(sample_size, mean_treatment, sd_treatment))
diet_therapy_group <- round(rnorm(sample_size, mean_diet_therapy, sd_diet_therapy))

# Объединяем в один датасет
treatment <- data.frame(New_method = treatment_group,
                            Dietotherapy = diet_therapy_group)
# Смотрим на результат
head(treatment)
```

H0 (нулевая гипотеза) - нет статистически значимых различий между эффективностью лечения новым методом и диетотерапией.

H1 (альтернативная гипотеза) - Есть статистически значимые различия между эффективностью лечения новым методом и диетотерапией.

$$
\alpha = 0.05
$$

```{r}
# визуальная оценка распределения уровня боли при использовании нового метода лечения  

ggplot(treatment, aes(x = New_method)) + 
            geom_histogram(binwidth = 1,fill = "red", color = "black") + 
            labs(title = "Гистограмма распределения уровня боли при использовании нового метода лечения", x = "Уровень боли", y = "Частота") + 
            theme_minimal() 
```

Распределение не похоже на нормальное.

```{r}
# визуальная оценка распределения уровня боли при использовании диетотерапии 

ggplot(treatment, aes(x = Dietotherapy)) + 
            geom_histogram(binwidth = 1,fill = "green", color = "black") + 
            labs(title = "Гистограмма распределения уровня боли при использовании диетотерапии", x = "Уровень боли", y = "Частота") + 
            theme_minimal() 
```

Распределение не похоже на нормальное.

```{r}
# тест Шапиро-Уилка на нормальность распределения 
# H0 - распределение нормальное 
# H1 - распределение отлично от нормального 
# alpha = 0.05

shapiro.test(treatment$New_method) 
shapiro.test(treatment$Dietotherapy)
```

Исходя из результатов теста Шапиро-Уилка для выборок:

Для уровня боли при использовании нового метода лечения

Значение p-value равно 0.1888, что больше стандартного уровня значимости 0.05. Нет достаточных доказательств для отвержения нулевой гипотезы о нормальном распределении данных. Таким образом, мы не можем отклонить нулевую гипотезу и предполагаем, что данные treatment\$New_method имеют нормальное распределение.

Для уровня боли при использовании диетотерапии

Значение p-value равно 0.002487, что меньше стандартного уровня значимости 0.05. Есть статистически значимые доказательства против нулевой гипотезы о нормальном распределении данных. Мы отвергаем нулевую гипотезу и предполагаем, что данные treatment\$Dietotherapy не имеют нормального распределения.

Соответсвенно выбираем Тест Манна-Уитни, так как он подходит для сравнения значений двух групп, когда распределения в каждой группе могут быть разными, но сами выборки являются независимыми и непрерывными или порядковыми.

```{r}
# определяем средние значения для каждой выборки
mean(treatment$New_method)
mean(treatment$Dietotherapy)

# Проводим двухвыборочный двусторониий тест Манна-Уитни
wilcox.test(treatment$New_method, treatment$Dietotherapy)
```

W = 545: Это значение W представляет собой статистику теста Wilcoxon rank sum, которая используется для сравнения рангов сумм двух выборок. p-value = 9.415e-07: Это очень маленькое p-значение, которое меньше стандартного уровня значимости 0.05. Следовательно, у нас есть статистически значимые доказательства против нулевой гипотезы о том, что истинный сдвиг местоположения (location shift) между двумя группами не равен нулю. Альтернативная гипотеза: Настоящий сдвиг местоположения (location shift) между двумя группами не равен нулю.

Таким образом, на основании результатов теста мы можем заключить, что существует статистически значимое различие между двумя группами

## Задание 4

Рассмотрите следующую гипотезу. Проводится исследование, в котором исследуются три противоопухолевые препарата A, B плацебо (0) на трех группах мышей. В каждой из трех групп по 10 мышей. Оценивается размер опухоли у мыши. Сгенерируйте датасет следующим образом: tumor \<- tibble( therapy = c(rep("0", 10), rep("A", 10), rep("B", 10)), value = c(rep(3213, 10), rep(2687, 10), rep(2423, 10)) ) %\>% mutate(therapy = factor(therapy, levels = c("0", "A", "B"))) tumor$value <- tumor$value + rnorm(30, 0, 760) Постройте на одном графике три “ящика с усами” для наглядности. проведите дисперсионный анализ, чтобы выяснить, есть ли разница между размером опухоли во всех группах. Прокомментируйте получившийся результат. с помощью функции TukeyHSD() проведите попарные сравнения, используя критерий Тьюки. Прокомментируйте полученные результаты.

```{r}
# Создание датасета
tumor <- tibble(
  therapy = c(rep("0", 10), rep("A", 10), rep("B", 10)),
  value = c(rep(3213, 10), rep(2687, 10), rep(2423, 10))
) %>%
  mutate(therapy = factor(therapy, levels = c("0", "A", "B")))
tumor$value <- tumor$value + rnorm(30, 0, 760)
```

```{r}
# Построение "ящиков с усами" для наглядности
ggplot(tumor, aes(x = therapy, y = value)) +
  geom_boxplot() +
  labs(x = "Терапия", y = "Размер опухоли") +
  ggtitle("Сравнение размера опухоли в различных терапевтических группах")
```

H0 (нулевая гипотеза) - нет статистически значимых различий между размером опухоли в 3 выборках.

H1 (альтернативная гипотеза) - Есть статистически значимые различия между размером опухоли в 3 выборках.

```{r}
# Дисперсионный анализ
anova_result <- aov(value ~ therapy, data = tumor)
summary(anova_result)
```

Результаты дисперсионного анализа (ANOVA) показывают следующее:

Фактор "therapy" имеет статистически значимое влияние на размер опухоли (p-value \< 0.001). F-статистика равна 11.59, что также указывает на значимое различие между группами. Поэтому мы отвергаем нулевую гипотезу о равенстве средних значений между группами и принимаем альтернативную гипотезу о том, что средние значения размера опухоли различаются в зависимости от применяемой терапии.

```{r}
# Выполнить тест Тьюки
tukey_result <- TukeyHSD(anova_result)

# Вывести результаты
print(tukey_result)
```

Средний размер опухоли в группе A статистически значимо отличается от размера опухоли в группе 0 (плацебо) (p = 0.038). Доверительный интервал для разницы между средними значениями находится в диапазоне от -1659.68 до -42.61, и не содержит ноль. Средний размер опухоли в группе B статистически значимо отличается от размера опухоли в группе 0 (плацебо) (p = 0.00015). Доверительный интервал для разницы между средними значениями находится в диапазоне от -2376.94 до -759.87, и не содержит ноль. Средний размер опухоли в группе B также статистически значимо отличается от размера опухоли в группе A (p = 0.089). Доверительный интервал для разницы между средними значениями находится в диапазоне от -1525.80 до 91.28 и содержит ноль, что указывает на то, что различие между этими группами может быть незначительным.
